# ワークフローの名前
name: Build Thesis Document

# ワークフローが実行されるトリガーを指定
on:
    # mainブランチにプッシュされたときに実行
    push:
        branches:
            - main
            - master
    # 手動でも実行できるようにする
    workflow_dispatch:

# 実行されるジョブを定義
jobs:
    build:
        # ubuntuの最新版仮想環境で実行
        runs-on: ubuntu-latest

        # ジョブのステップを定義
        steps:
            # 1. リポジトリのコードをチェックアウトする
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Python環境をセットアップする
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            # 3. Pandocをセットアップする
            - name: Set up Pandoc
              uses: r-lib/actions/setup-pandoc@v2
              with:
                  pandoc-version: "3.1.2" # 安定版に固定

            # 4. LaTeX環境をインストールする
            - name: Install LaTeX
              run: |
                  sudo apt-get update
                  sudo apt-get install -y texlive-latex-extra texlive-fonts-recommended

            # 5. pandoc-crossrefをインストールする（バージョン固定）
            - name: Install pandoc-crossref
              run: |
                  # 安定版のpandoc-crossrefをダウンロード
                  wget -q https://github.com/lierdakil/pandoc-crossref/releases/download/v0.3.15.0a/pandoc-crossref-Linux.tar.xz
                  tar -xf pandoc-crossref-Linux.tar.xz
                  sudo mv pandoc-crossref /usr/local/bin/
                  sudo chmod +x /usr/local/bin/pandoc-crossref

                  # インストール確認
                  pandoc-crossref --version
                  echo "pandoc-crossref installed successfully."

            # 6. Pythonスクリプトを実行してドキュメントをビルドする
            - name: Run Pandoc Runner Script
              run: python3 pandoc_runner.py

            # 7. 生成されたファイルをアーティファクトとしてアップロードする
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  # アーティファクトの名前
                  name: thesis-document
                  # アップロードするファイルのパス（ワイルドカード対応）
                  path: |
                      **/*.docx
                      **/*.pdf

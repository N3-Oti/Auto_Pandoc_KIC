# ワークフローの名前
name: Build Thesis Document

# ワークフローが実行されるトリガーを指定
on:
    # mainブランチにプッシュされたときに実行
    push:
        branches:
            - main
            - master
    # 手動でも実行できるようにする
    workflow_dispatch:

# 実行されるジョブを定義
jobs:
    build:
        # ubuntuの最新版仮想環境で実行
        runs-on: ubuntu-latest

        # ジョブのステップを定義
        steps:
            # 1. リポジトリのコードをチェックアウトする
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Python環境をセットアップする
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            # 3. Pandocをセットアップする
            - name: Set up Pandoc
              uses: r-lib/actions/setup-pandoc@v2
              with:
                  pandoc-version: "3.8" # pandoc-crossrefと互換性のあるバージョン

            # 4. LaTeX環境をインストールする
            #- name: Install LaTeX
            #  run: |
            #      sudo apt-get update
            #      sudo apt-get install -y texlive-latex-extra texlive-fonts-recommended

            # 5. pandoc-crossrefをインストールする（動的取得）
            - name: Install pandoc-crossref
              run: |
                  echo "Fetching latest pandoc-crossref release information..."

                  # jqをインストール
                  sudo apt-get update && sudo apt-get install -y jq

                  # GitHub APIからリリース情報を取得
                  RELEASE_INFO=$(curl -sL \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "https://api.github.com/repos/lierdakil/pandoc-crossref/releases/latest")

                  # デバッグ：利用可能なアセット名を表示
                  echo "Available assets:"
                  echo "$RELEASE_INFO" | jq -r '.assets[].name'

                  # Linux用のtar.xzファイルを検索
                  LATEST_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("Linux.*\\.tar\\.xz$")) | .browser_download_url' | head -n 1)

                  # URLが取得できたか確認
                  if [ -z "$LATEST_URL" ] || [ "$LATEST_URL" = "null" ]; then
                    echo "Error: Could not retrieve the download URL."
                    echo "Available assets:"
                    echo "$RELEASE_INFO" | jq -r '.assets[].name'
                    exit 1
                  fi

                  echo "Downloading from: $LATEST_URL"
                  wget -q -O pandoc-crossref.tar.xz "$LATEST_URL"

                  # 解凍してインストール
                  tar -xf pandoc-crossref.tar.xz
                  sudo mv pandoc-crossref /usr/local/bin/
                  sudo chmod +x /usr/local/bin/pandoc-crossref

                  # インストール確認
                  pandoc-crossref --version
                  echo "pandoc-crossref installed successfully."

            # 6. Pythonスクリプトを実行してドキュメントをビルドする
            - name: Run Pandoc Runner Script
              run: python3 pandoc_runner.py

            # 7. 生成されたファイルをアーティファクトとしてアップロードする
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  # アーティファクトの名前
                  name: thesis-document
                  # アップロードするファイルのパス（ワイルドカード対応）
                  path: |
                      **/*.docx
                      **/*.pdf

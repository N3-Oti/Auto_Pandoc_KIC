# ワークフローの名前
name: Build Thesis Document

# ワークフローが実行されるトリガーを指定
on:
    # mainブランチにプッシュされたときに実行
    push:
        branches:
            - main
            - master
    # 手動でも実行できるようにする
    workflow_dispatch:

# 実行されるジョブを定義
jobs:
    build:
        # ubuntuの最新版仮想環境で実行
        runs-on: ubuntu-latest

        # ジョブのステップを定義
        steps:
            # 1. リポジトリのコードをチェックアウトする
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Python環境をセットアップする
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            # 3. Pandocをセットアップする
            - name: Set up Pandoc
              uses: r-lib/actions/setup-pandoc@v2
              with:
                  pandoc-version: "latest"

            # 4. pandoc-crossrefをダウンロードしてインストールする (改善版)
            - name: Install pandoc-crossref
              run: |
                  echo "Fetching latest pandoc-crossref release information..."

                  # GitHub APIからリリース情報を取得
                  RELEASE_INFO=$(curl -sL \
                    -H "Accept: application/vnd.github+json" \
                    -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                    -H "X-GitHub-Api-Version: 2022-11-28" \
                    "https://api.github.com/repos/lierdakil/pandoc-crossref/releases/latest")

                  # デバッグ：利用可能なアセット名を表示
                  echo "Available assets:"
                  echo "$RELEASE_INFO" | grep -o '"name": *"[^"]*"' | cut -d'"' -f4

                  # Linux用のtar.xzファイルを検索（複数パターンに対応）
                  LATEST_URL=$(echo "$RELEASE_INFO" | grep -oP '"browser_download_url":\s*"\K[^"]*Linux[^"]*\.tar\.xz' | head -n 1)

                  # URLが取得できたか確認
                  if [ -z "$LATEST_URL" ]; then
                    echo "Error: Could not retrieve the download URL."
                    echo "Trying alternative method..."
                    
                    # 代替方法：jqを使用してJSONを解析
                    sudo apt-get update && sudo apt-get install -y jq
                    LATEST_URL=$(echo "$RELEASE_INFO" | jq -r '.assets[] | select(.name | test("Linux.*\\.tar\\.xz$")) | .browser_download_url' | head -n 1)
                    
                    if [ -z "$LATEST_URL" ]; then
                      echo "Error: Still could not retrieve the download URL."
                      exit 1
                    fi
                  fi

                  echo "Downloading from: $LATEST_URL"
                  wget -q -O pandoc-crossref.tar.xz "$LATEST_URL"

                  # 解凍してインストール
                  tar -xf pandoc-crossref.tar.xz
                  sudo mv pandoc-crossref /usr/local/bin/
                  sudo chmod +x /usr/local/bin/pandoc-crossref

                  # インストール確認
                  pandoc-crossref --version
                  echo "pandoc-crossref installed successfully."

            # 5. Pythonスクリプトを実行してWordドキュメントをビルドする
            - name: Run Pandoc Runner Script
              run: python3 pandoc_runner.py

            # 6. 生成されたWordファイルをアーティファクトとしてアップロードする
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  # アーティファクトの名前
                  name: thesis-document
                  # アップロードするファイルのパス
                  path: |
                  修士論文_氏名.docx
                  修士論文_氏名.pdf

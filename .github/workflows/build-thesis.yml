# ã‚µãƒ–ãƒ¢ã‚¸ãƒ¥ãƒ¼ãƒ«ç”¨ã®è«–æ–‡ãƒ“ãƒ«ãƒ‰ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ï¼ˆä¿®æ­£ç‰ˆï¼‰
name: Build Thesis Document

# ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ãŒå®Ÿè¡Œã•ã‚Œã‚‹ãƒˆãƒªã‚¬ãƒ¼ã‚’æŒ‡å®š
on:
  # mainãƒ–ãƒ©ãƒ³ãƒã«ãƒ—ãƒƒã‚·ãƒ¥ã•ã‚ŒãŸã¨ãã«å®Ÿè¡Œ
  push:
    branches:
      - main
      - master

  # æ‰‹å‹•ã§ã‚‚å®Ÿè¡Œã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹
  workflow_dispatch:

  # ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®å‘¼ã³å‡ºã—
  repository_dispatch:
    types: [thesis-build-requested]

# å®Ÿè¡Œã•ã‚Œã‚‹ã‚¸ãƒ§ãƒ–ã‚’å®šç¾©
jobs:
  build:
    # ubuntuã®æœ€æ–°ç‰ˆä»®æƒ³ç’°å¢ƒã§å®Ÿè¡Œ
    runs-on: ubuntu-latest

    # ã‚¸ãƒ§ãƒ–ã®ã‚¹ãƒ†ãƒƒãƒ—ã‚’å®šç¾©
    steps:
      # 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚³ãƒ¼ãƒ‰ã‚’ãƒã‚§ãƒƒã‚¯ã‚¢ã‚¦ãƒˆã™ã‚‹
      - name: Checkout repository
        uses: actions/checkout@v4

      # 2. ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®å‘¼ã³å‡ºã—æƒ…å ±ã‚’è¡¨ç¤º
      - name: Display build information
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "ğŸ¯ ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã‹ã‚‰ã®ãƒ“ãƒ«ãƒ‰è¦æ±‚ã‚’å—ä¿¡"
          echo "ğŸ“‹ å‘¼ã³å‡ºã—æƒ…å ±:"
          echo "  - ã‚½ãƒ¼ã‚¹: ${{ github.event.client_payload.source }}"
          echo "  - ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—: ${{ github.event.client_payload.timestamp }}"
          echo "  - ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.event.client_payload.main_repo }}"
          echo "  - ã‚³ãƒŸãƒƒãƒˆSHA: ${{ github.event.client_payload.commit_sha }}"

      # 3. å‡ºåŠ›ãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã‚’ä½œæˆ
      - name: Create output directory
        run: mkdir -p output

      # 4. reference.docxãŒå­˜åœ¨ã™ã‚‹ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ä»˜ãï¼‰
      - name: Check for reference.docx
        run: |
          echo "=== DEBUG: Checking for reference.docx ==="
          echo "Current directory contents:"
          ls -la
          echo ""
          echo "Checking for reference.docx..."
          if [ -f "reference.docx" ]; then
            echo "âœ… reference.docx found!"
            echo "File size: $(ls -lh reference.docx | awk '{print $5}')"
            echo "File permissions: $(ls -l reference.docx | awk '{print $1}')"
            echo "Will use as template"
            echo "REFERENCE_DOC=--reference-doc=reference.docx" >> $GITHUB_ENV
          else
            echo "âŒ reference.docx not found"
            echo "Available .docx files:"
            ls -la *.docx 2>/dev/null || echo "No .docx files found"
            echo "Using default template"
            echo "REFERENCE_DOC=" >> $GITHUB_ENV
          fi
          echo "REFERENCE_DOC environment variable set to: ${{ env.REFERENCE_DOC }}"
          echo "=== END DEBUG ==="

      # 5. Pandocã‚³ãƒãƒ³ãƒ‰ã®è©³ç´°ãƒ­ã‚°ã‚’è¡¨ç¤º
      - name: Show Pandoc command details
        run: |
          echo "=== DEBUG: Pandoc Command Details ==="
          echo "REFERENCE_DOC: ${{ env.REFERENCE_DOC }}"
          echo "Full command will be:"
          echo "pandoc --defaults=defaults.yaml --citeproc --bibliography=references.bib ${{ env.REFERENCE_DOC }} -V toc-title=ç›®æ¬¡ -V lot-title=è¡¨ç›®æ¬¡ -V lof-title=å›³ç›®æ¬¡ --filter=pandoc-crossref --output=output/thesis.docx [chapter files]"
          echo ""
          echo "Checking input files:"
          for file in ./chapters/*.md; do
            if [ -f "$file" ]; then
              echo "âœ… $file ($(ls -lh "$file" | awk '{print $5}'))"
            else
              echo "âŒ $file (not found)"
            fi
          done
          echo "=== END DEBUG ==="

      # 6. ç« ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•å–å¾—ã—ã¦Pandocã§å¤‰æ›
      - name: Get chapter files and convert with Pandoc
        run: |
          echo "=== DEBUG: Getting chapter files ==="

          # chaptersãƒ‡ã‚£ãƒ¬ã‚¯ãƒˆãƒªã®.mdãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç•ªå·é †ã«ã‚½ãƒ¼ãƒˆã—ã¦å–å¾—
          CHAPTER_FILES=$(find ./chapters -name "*.md" | sort)

          echo "Found chapter files:"
          echo "$CHAPTER_FILES"

          # Pandocã‚³ãƒãƒ³ãƒ‰ã®å¼•æ•°ã‚’æ§‹ç¯‰
          PANDOC_ARGS="--defaults=defaults.yaml --citeproc --bibliography=references.bib $REFERENCE_DOC -V toc-title=ç›®æ¬¡ -V lot-title=è¡¨ç›®æ¬¡ -V lof-title=å›³ç›®æ¬¡ --filter=pandoc-crossref --output=output/thesis.docx"

          # ç« ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
          for file in $CHAPTER_FILES; do
            PANDOC_ARGS="$PANDOC_ARGS $file"
          done

          echo "=== DEBUG: Pandoc arguments ==="
          echo "$PANDOC_ARGS"

          echo "=== END DEBUG ==="

          # Pandocã®å¼•æ•°ã‚’ç’°å¢ƒå¤‰æ•°ã¨ã—ã¦è¨­å®š
          echo "PANDOC_ARGS=$PANDOC_ARGS" >> $GITHUB_ENV

      # 7. Dockerã§Pandocã‚’å®Ÿè¡Œã—ã¦å¤‰æ›
      - name: Convert documents with Pandoc
        uses: docker://pandoc/latex:3.5
        with:
          args: ${{ env.PANDOC_ARGS }}

      # 8. å¤‰æ›çµæœã®ç¢ºèª
      - name: Verify conversion results
        run: |
          echo "=== DEBUG: Conversion Results ==="
          echo "Output directory contents:"
          ls -la output/
          echo ""
          if [ -f "output/thesis.docx" ]; then
            echo "âœ… thesis.docx created successfully!"
            echo "File size: $(ls -lh output/thesis.docx | awk '{print $5}')"
            echo "File permissions: $(ls -l output/thesis.docx | awk '{print $1}')"
          else
            echo "âŒ thesis.docx not found in output directory"
          fi
          echo "=== END DEBUG ==="

      # 9. ç”Ÿæˆã•ã‚ŒãŸWordãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹
      - name: Upload Artifact
        uses: actions/upload-artifact@v4
        with:
          # ã‚¢ãƒ¼ãƒ†ã‚£ãƒ•ã‚¡ã‚¯ãƒˆã®åå‰
          name: thesis-document
          # ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã®ãƒ‘ã‚¹
          path: output/

      # 10. ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒªã«çµæœã‚’é€šçŸ¥ï¼ˆã‚ªãƒ—ã‚·ãƒ§ãƒ³ï¼‰
      - name: Notify main repository
        if: github.event_name == 'repository_dispatch'
        run: |
          echo "ğŸ‰ è«–æ–‡ãƒ“ãƒ«ãƒ‰ãŒå®Œäº†ã—ã¾ã—ãŸï¼"
          echo "ğŸ“‹ ãƒ¡ã‚¤ãƒ³ãƒªãƒã‚¸ãƒˆãƒª: ${{ github.event.client_payload.main_repo }}"
          echo "ğŸ“„ Wordãƒ•ã‚¡ã‚¤ãƒ«ã¯Artifactsã‹ã‚‰ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™"

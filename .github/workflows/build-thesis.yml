# ワークフローの名前
name: Build Thesis Document

# ワークフローが実行されるトリガーを指定
on:
    # mainブランチにプッシュされたときに実行
    push:
        branches:
            - main
            - master
    # 手動でも実行できるようにする
    workflow_dispatch:

# 実行されるジョブを定義
jobs:
    build:
        # ubuntuの最新版仮想環境で実行
        runs-on: ubuntu-latest

        # ジョブのステップを定義
        steps:
            # 1. リポジトリのコードをチェックアウトする
            - name: Checkout repository
              uses: actions/checkout@v4

            # 2. Python環境をセットアップする
            - name: Set up Python
              uses: actions/setup-python@v5
              with:
                  python-version: "3.11"

            # 3. Pandocをセットアップする
            - name: Set up Pandoc
              uses: r-lib/actions/setup-pandoc@v2
              with:
                  pandoc-version: "latest"

            # 4. pandoc-crossrefをダウンロードしてインストールする (修正版)
            - name: Install pandoc-crossref
              run: |
                  echo "Fetching latest pandoc-crossref release URL..."
                  # GitHub APIに認証付きで問い合わせるように修正
                  LATEST_URL=$(curl -sL -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" "https://api.github.com/repos/lierdakil/pandoc-crossref/releases/latest" | grep "browser_download_url.*Linux.tar.xz" | cut -d '"' -f 4)

                  # URLが取得できたか確認する
                  if [ -z "$LATEST_URL" ]; then
                    echo "Error: Could not retrieve the download URL."
                    exit 1
                  fi

                  echo "Downloading from: $LATEST_URL"
                  wget -q -O pandoc-crossref.tar.xz "$LATEST_URL"
                  tar -xvf pandoc-crossref.tar.xz
                  sudo mv pandoc-crossref /usr/local/bin/
                  echo "pandoc-crossref installed successfully."

            # 5. Pythonスクリプトを実行してWordドキュメントをビルドする
            - name: Run Pandoc Runner Script
              run: python3 pandoc_runner.py

            # 6. 生成されたWordファイルをアーティファクトとしてアップロードする
            - name: Upload Artifact
              uses: actions/upload-artifact@v4
              with:
                  # アーティファクトの名前
                  name: thesis-document
                  # アップロードするファイルのパス
                  path: 修士論文_氏名.docx
